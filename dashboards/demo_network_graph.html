<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Visualization Demo - HoloLoom Dashboard</title>

    <!-- Tailwind CSS (CDN, no build step) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Plotly.js (interactive charts) -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <!-- D3.js (force-directed graphs) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        /* Edward Tufte-inspired typography */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #1f2937;
            line-height: 1.6;
        }

        /* Minimal chrome, maximum data-ink ratio */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Smooth transitions */
        .panel {
            transition: box-shadow 0.2s ease;
        }

        .panel:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Panel state management */
        .panel-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .panel.expanded {
            border-color: #6366f1;
            border-width: 2px;
        }

        /* Dark theme support */
        .dark-theme {
            background: #1f2937;
            color: #f3f4f6;
        }

        .dark-theme .bg-white {
            background: #374151 !important;
            color: #f3f4f6;
        }

        .dark-theme .text-gray-900 {
            color: #f3f4f6 !important;
        }

        .dark-theme .text-gray-500 {
            color: #9ca3af !important;
        }

        .dark-theme .border-gray-200 {
            border-color: #4b5563 !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="dashboard-container">
        <!-- Dashboard Title (Tufte: Clear hierarchy) -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Network Visualization Demo</h1>
            <div class="h-1 w-24 bg-indigo-600 rounded"></div>
        </div>

        <!-- Dashboard Grid (Responsive layout) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div class="md:col-span-2 lg:col-span-3 p-6 rounded-lg shadow-sm border border-gray-200 bg-white">
            <div class="text-lg font-semibold text-gray-800 mb-1">Thread Activation Network</div>
            <div class="text-sm text-gray-600 mb-4">Interactive force-directed graph (drag nodes to explore)</div>
            <div id="plot_network_1" style="height: 400px; border: 1px solid #e5e7eb; border-radius: 0.375rem; background: #fafafa;"></div>
            <div class="text-xs text-gray-500 mt-2">5 node(s), 5 edge(s)</div>
        </div>
        <script>
        (function() {
            // D3.js Force-Directed Graph
            const width = document.getElementById('plot_network_1').clientWidth;
            const height = 400;

            const svg = d3.select('#plot_network_1')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const nodes = [{"id": "motif", "label": "Motif Detector", "size": 15, "color": "#6366f1"}, {"id": "embedding", "label": "Embeddings", "size": 18, "color": "#10b981"}, {"id": "spectral", "label": "Spectral", "size": 12, "color": "#f59e0b"}, {"id": "graph", "label": "Graph Store", "size": 20, "color": "#ef4444"}, {"id": "policy", "label": "Policy Engine", "size": 16, "color": "#8b5cf6"}];
            const links = [{"source": "motif", "target": "policy"}, {"source": "embedding", "target": "policy"}, {"source": "spectral", "target": "policy"}, {"source": "graph", "target": "embedding"}, {"source": "graph", "target": "spectral"}];

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Draw edges
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', '#94a3b8')
                .attr('stroke-width', 2);

            // Draw nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Node circles
            node.append('circle')
                .attr('r', d => d.size || 12)
                .attr('fill', d => d.color || '#6366f1')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            // Node labels
            node.append('text')
                .text(d => d.label)
                .attr('x', 0)
                .attr('y', 25)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('fill', '#374151');

            // Tooltip on hover
            node.append('title')
                .text(d => d.label + (d.description ? '\n' + d.description : ''));

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        })();
        </script>
        
        </div>

        <!-- Metadata Footer -->

        <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-500 text-center">
            Complexity: FAST | Panels: 1
            <br>
            Generated: 2025-10-29T01:16:55
        </div>
        
    </div>

    <!-- Dashboard Interactivity -->
    <script>
/**
 * HoloLoom Dashboard Interactivity
 * ==================================
 * Client-side JavaScript for interactive self-constructing dashboards.
 *
 * Features:
 * - Panel expand/collapse
 * - User preference management
 * - localStorage persistence
 * - Drill-down interactions
 * - Theme switching
 * - Panel reordering
 *
 * Author: Claude Code
 * Date: October 29, 2025
 */

(function() {
    'use strict';

    // ========================================================================
    // State Management
    // ========================================================================

    class DashboardState {
        constructor() {
            this.panels = new Map();  // panel_id -> state
            this.preferences = this.loadPreferences();
            this.expandedPanels = new Set();
            this.init();
        }

        init() {
            // Load panel states from localStorage
            const saved = localStorage.getItem('hololoom_panel_states');
            if (saved) {
                const states = JSON.parse(saved);
                Object.entries(states).forEach(([id, state]) => {
                    this.panels.set(id, state);
                    if (state.expanded) {
                        this.expandedPanels.add(id);
                    }
                });
            }
        }

        loadPreferences() {
            const saved = localStorage.getItem('hololoom_preferences');
            if (saved) {
                return JSON.parse(saved);
            }
            // Default preferences
            return {
                preferred_panels: [],
                hidden_panels: [],
                layout_preference: null,
                color_scheme: 'light',
                detail_level: 'standard',
                max_panels: null,
                enable_animations: true,
                auto_expand_errors: true,
                panel_sizes: {}
            };
        }

        savePreferences() {
            localStorage.setItem('hololoom_preferences', JSON.stringify(this.preferences));
        }

        setPanelState(panelId, state) {
            this.panels.set(panelId, { ...this.panels.get(panelId), ...state });
            this.savePanelStates();
        }

        savePanelStates() {
            const states = {};
            this.panels.forEach((state, id) => {
                states[id] = state;
            });
            localStorage.setItem('hololoom_panel_states', JSON.stringify(states));
        }

        togglePanel(panelId) {
            if (this.expandedPanels.has(panelId)) {
                this.expandedPanels.delete(panelId);
                this.setPanelState(panelId, { expanded: false });
                return false;
            } else {
                this.expandedPanels.add(panelId);
                this.setPanelState(panelId, { expanded: true });
                return true;
            }
        }

        setPreference(key, value) {
            this.preferences[key] = value;
            this.savePreferences();
        }

        clearAll() {
            localStorage.removeItem('hololoom_panel_states');
            localStorage.removeItem('hololoom_preferences');
            this.panels.clear();
            this.expandedPanels.clear();
            this.preferences = this.loadPreferences();
        }
    }

    // ========================================================================
    // Panel Interactions
    // ========================================================================

    class PanelController {
        constructor(state) {
            this.state = state;
        }

        attachHandlers() {
            // Find all panels
            document.querySelectorAll('[data-panel-id]').forEach(panel => {
                this.attachPanelHandlers(panel);
            });
        }

        attachPanelHandlers(panel) {
            const panelId = panel.dataset.panelId;
            const panelType = panel.dataset.panelType;

            // Add expand/collapse button if not present
            this.addExpandButton(panel, panelId);

            // Add drill-down click handler
            this.addDrillDownHandler(panel, panelId, panelType);

            // Restore saved state
            this.restorePanelState(panel, panelId);
        }

        addExpandButton(panel, panelId) {
            // Check if button already exists
            if (panel.querySelector('.expand-btn')) return;

            // Find panel header
            const header = panel.querySelector('.panel-header') ||
                          panel.querySelector('h3') ||
                          panel.querySelector('.text-lg');

            if (!header) return;

            // Create expand button
            const btn = document.createElement('button');
            btn.className = 'expand-btn ml-2 text-gray-500 hover:text-gray-700 transition-colors';
            btn.innerHTML = '<svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
            btn.setAttribute('aria-label', 'Expand panel');

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.togglePanel(panel, panelId);
            });

            // Add button to header
            if (header.style.display !== 'flex') {
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.justifyContent = 'space-between';
            }
            header.appendChild(btn);
        }

        togglePanel(panel, panelId) {
            const isExpanded = this.state.togglePanel(panelId);
            const content = panel.querySelector('.panel-content') || panel.querySelector('div:not(.panel-header)');
            const btn = panel.querySelector('.expand-btn svg');

            if (!content) return;

            if (isExpanded) {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                content.classList.remove('collapsed');
                if (btn) btn.style.transform = 'rotate(180deg)';
                panel.classList.add('expanded');
            } else {
                // Collapse
                content.style.maxHeight = '0';
                content.classList.add('collapsed');
                if (btn) btn.style.transform = 'rotate(0deg)';
                panel.classList.remove('expanded');
            }

            // Animate if enabled
            if (this.state.preferences.enable_animations) {
                content.style.transition = 'max-height 0.3s ease-in-out';
            }
        }

        addDrillDownHandler(panel, panelId, panelType) {
            // Add click handler for drill-down
            panel.style.cursor = 'pointer';

            panel.addEventListener('click', (e) => {
                // Don't drill down if clicking on interactive elements
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                if (e.target.tagName === 'A' || e.target.closest('a')) return;

                this.showDrillDown(panel, panelId, panelType);
            });
        }

        showDrillDown(panel, panelId, panelType) {
            // Create modal for drill-down
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full m-4 max-h-[90vh] overflow-auto">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Panel Details: ${panelType}</h2>
                        <button class="close-btn text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6">
                        ${this.getDrillDownContent(panel, panelType)}
                    </div>
                </div>
            `;

            // Add close handler
            modal.querySelector('.close-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
        }

        getDrillDownContent(panel, panelType) {
            // Extract detailed data from panel
            const content = panel.cloneNode(true);

            // Remove interactive elements
            content.querySelectorAll('.expand-btn').forEach(el => el.remove());

            // Add type-specific enhancements
            if (panelType === 'timeline') {
                return `
                    <div class="space-y-4">
                        ${content.innerHTML}
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h3 class="text-lg font-semibold mb-2">Stage Details</h3>
                            <p class="text-sm text-gray-600">
                                Click on chart bars for per-stage breakdown.
                                Use mouse wheel to zoom, drag to pan.
                            </p>
                        </div>
                    </div>
                `;
            } else if (panelType === 'network') {
                return `
                    <div class="space-y-4">
                        ${content.innerHTML}
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h3 class="text-lg font-semibold mb-2">Network Controls</h3>
                            <p class="text-sm text-gray-600">
                                Drag nodes to rearrange. Double-click nodes for details.
                                Scroll to zoom.
                            </p>
                        </div>
                    </div>
                `;
            } else {
                return content.innerHTML;
            }
        }

        restorePanelState(panel, panelId) {
            const savedState = this.state.panels.get(panelId);
            if (savedState && savedState.expanded) {
                // Restore expanded state
                setTimeout(() => this.togglePanel(panel, panelId), 100);
            }

            // Auto-expand errors if preference is set
            if (this.state.preferences.auto_expand_errors &&
                panel.dataset.panelType === 'text' &&
                panel.textContent.toLowerCase().includes('error')) {
                setTimeout(() => this.togglePanel(panel, panelId), 100);
            }
        }
    }

    // ========================================================================
    // Preferences UI
    // ========================================================================

    class PreferencesUI {
        constructor(state) {
            this.state = state;
        }

        createPreferencesButton() {
            const btn = document.createElement('button');
            btn.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition-colors z-40';
            btn.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            `;
            btn.setAttribute('aria-label', 'Dashboard preferences');
            btn.addEventListener('click', () => this.showPreferences());
            document.body.appendChild(btn);
        }

        showPreferences() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full m-4 max-h-[90vh] overflow-auto">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900">Dashboard Preferences</h2>
                    </div>
                    <div class="p-6 space-y-6">
                        ${this.getPreferencesForm()}
                    </div>
                    <div class="p-6 border-t border-gray-200 flex justify-between">
                        <button class="clear-btn px-4 py-2 text-red-600 hover:bg-red-50 rounded">Clear All</button>
                        <div class="space-x-2">
                            <button class="cancel-btn px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Cancel</button>
                            <button class="save-btn px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
                        </div>
                    </div>
                </div>
            `;

            // Attach handlers
            modal.querySelector('.save-btn').addEventListener('click', () => {
                this.savePreferencesFromForm(modal);
                document.body.removeChild(modal);
                window.location.reload();  // Reload to apply preferences
            });

            modal.querySelector('.cancel-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            modal.querySelector('.clear-btn').addEventListener('click', () => {
                if (confirm('Clear all saved preferences and panel states?')) {
                    this.state.clearAll();
                    document.body.removeChild(modal);
                    window.location.reload();
                }
            });

            document.body.appendChild(modal);
        }

        getPreferencesForm() {
            const prefs = this.state.preferences;
            return `
                <div class="space-y-4">
                    <!-- Theme -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color Scheme</label>
                        <select id="pref-color-scheme" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="light" ${prefs.color_scheme === 'light' ? 'selected' : ''}>Light</option>
                            <option value="dark" ${prefs.color_scheme === 'dark' ? 'selected' : ''}>Dark</option>
                        </select>
                    </div>

                    <!-- Detail Level -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Detail Level</label>
                        <select id="pref-detail-level" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="minimal" ${prefs.detail_level === 'minimal' ? 'selected' : ''}>Minimal</option>
                            <option value="standard" ${prefs.detail_level === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="detailed" ${prefs.detail_level === 'detailed' ? 'selected' : ''}>Detailed</option>
                        </select>
                    </div>

                    <!-- Max Panels -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Panels</label>
                        <input type="number" id="pref-max-panels" value="${prefs.max_panels || ''}"
                               placeholder="No limit" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Animations -->
                    <div class="flex items-center">
                        <input type="checkbox" id="pref-animations" ${prefs.enable_animations ? 'checked' : ''}
                               class="mr-2 h-4 w-4 text-indigo-600">
                        <label for="pref-animations" class="text-sm text-gray-700">Enable animations</label>
                    </div>

                    <!-- Auto-expand errors -->
                    <div class="flex items-center">
                        <input type="checkbox" id="pref-auto-expand-errors" ${prefs.auto_expand_errors ? 'checked' : ''}
                               class="mr-2 h-4 w-4 text-indigo-600">
                        <label for="pref-auto-expand-errors" class="text-sm text-gray-700">Auto-expand error panels</label>
                    </div>
                </div>
            `;
        }

        savePreferencesFromForm(modal) {
            this.state.setPreference('color_scheme', modal.querySelector('#pref-color-scheme').value);
            this.state.setPreference('detail_level', modal.querySelector('#pref-detail-level').value);
            this.state.setPreference('max_panels', parseInt(modal.querySelector('#pref-max-panels').value) || null);
            this.state.setPreference('enable_animations', modal.querySelector('#pref-animations').checked);
            this.state.setPreference('auto_expand_errors', modal.querySelector('#pref-auto-expand-errors').checked);
        }
    }

    // ========================================================================
    // Initialization
    // ========================================================================

    function initDashboard() {
        const state = new DashboardState();
        const panelController = new PanelController(state);
        const preferencesUI = new PreferencesUI(state);

        // Attach panel handlers
        panelController.attachHandlers();

        // Create preferences button
        preferencesUI.createPreferencesButton();

        // Apply theme
        if (state.preferences.color_scheme === 'dark') {
            document.body.classList.add('dark-theme');
        }

        // Expose to window for debugging
        window.HoloLoom = { state, panelController, preferencesUI };

        console.log('[HoloLoom] Dashboard initialized');
    }

    // Auto-initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
        initDashboard();
    }

})();

    </script>
</body>
</html>
